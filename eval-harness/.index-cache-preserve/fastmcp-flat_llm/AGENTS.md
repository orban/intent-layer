# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

FastMCP is a Python framework (â‰¥3.10) for building Model Context Protocol (MCP) servers and clients. It provides decorator-based registration of tools, resources, and prompts that LLMs can interact with.

## Essential Commands

```bash
uv sync                              # Install/update dependencies (always run first)
uv run pytest -n auto                # Run full test suite in parallel
uv run pytest -xvs tests/path/to_test.py::test_name  # Run a single test
uv run pytest -xvs tests/path/to_test.py  # Run a single test file
uv run prek run --all-files          # Run all static checks (ruff + prettier + ty)
```

**All tests and static checks must pass before committing.** The justfile has shortcuts (`just test`, `just build`, `just typecheck`) but the commands above are the primary workflow.

## Architecture

### Four Core MCP Object Types

Changes to one type almost always require parallel changes to the other three:

- **Tools** (`src/fastmcp/tools/`) â€” callable functions exposed to LLMs
- **Resources** (`src/fastmcp/resources/`) â€” data sources accessible by URI
- **Resource Templates** (`src/fastmcp/resources/`) â€” parameterized resource URI patterns
- **Prompts** (`src/fastmcp/prompts/`) â€” prompt templates

### Provider System

The `Provider` base class (`src/fastmcp/server/providers/base.py`) is the core abstraction for dynamically sourcing MCP components at runtime. Providers implement `_list_tools()`, `_get_tool()`, and equivalent methods for resources/prompts/templates. Key implementations: `LocalProvider` (decorator-registered components), `ProxyProvider` (proxies to another MCP server), `FileSystemProvider`, `OpenAPIProvider`, `AggregateProvider`.

Static components (via decorators) always take precedence over providers. Providers are queried in registration order; first non-None result wins.

### Transform Pipeline

Transforms (`src/fastmcp/server/transforms/`) modify components as they flow through the system (namespacing, visibility filtering, tool parameter modification, version filtering, converting prompts/resources into tools). Each provider carries its own transform chain.

### Middleware Pipeline

Server middleware (`src/fastmcp/server/middleware/`) uses typed hooks (`on_call_tool`, `on_read_resource`, `on_list_tools`, `on_initialize`, etc.) following a Django-like dispatch pattern. Built-in middleware handles error handling, logging, rate limiting, caching, timing, authorization, and tool injection.

### Server Mixins

`FastMCP` (`src/fastmcp/server/server.py`) composes behavior from mixins in `src/fastmcp/server/mixins/`: `LifespanMixin`, `MCPOperationsMixin` (core protocol operations), and `TransportMixin` (stdio/HTTP/SSE transport handling).

### Client Architecture

`Client` (`src/fastmcp/client/client.py`) uses transport abstraction (stdio, HTTP, SSE, streamable HTTP, memory) and mixin pattern for protocol operations. Sessions support reentrant context managers with reference counting.

### Public API

The top-level `fastmcp` package exports only: `FastMCP`, `Client`, `Context`, `settings`. Be intentional about re-exports â€” specialized features should live in their submodules.

## Testing Conventions

- `asyncio_mode = "auto"` is set globally â€” **never add `@pytest.mark.asyncio`** decorators
- Default test timeout is **5 seconds** â€” optimize or mark slow tests with `@pytest.mark.integration`
- Tests use in-memory transport by default (no network I/O)
- `tests/conftest.py` provides `fastmcp_server`, `tool_server`, `tagged_resources_server` fixtures, plus autouse fixtures for settings isolation and logger propagation
- Inline snapshots are disabled by default; use `--inline-snapshot=create` or `--inline-snapshot=fix` when needed
- Integration tests go in `tests/integration_tests/` and are auto-marked

## Code Standards

- Full type annotations required; type checker is **ty** (`uv run ty check`)
- File sizes enforced by **loq** (default 1000 lines). Edit `loq.toml` to raise limits; run `loq baseline` to ratchet down
- Linting/formatting via **Ruff** â€” extended rules (bugbear, comprehensions, simplify) apply only to `src/` code
- Never use bare `except` â€” always specify exception types
- `docs/python-sdk/` is auto-generated by a bot â€” do not manually edit

## Git Rules

- Never force-push on collaborative repos
- Never amend commits to fix prek failures â€” make a new commit
- Agents must self-identify (e.g., "ðŸ¤– Generated with Claude Code" in commits/PRs)
- Keep commit messages brief â€” headlines, not paragraphs
- PR bodies: 1-2 paragraphs with a code example, not bullet summaries
